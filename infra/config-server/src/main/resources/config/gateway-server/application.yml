server:
  port: 8080

spring:
  application:
    name: gateway-server
  cloud:
    gateway:
      discovery:
        locator:
          enabled: true
          lower-case-service-id: true
          predicates:
            - name: Path
              args:
                pattern: "'/' + serviceId.toLowerCase() + '/**'"
          filters:
            - name: RewritePath
              args:
                regexp: "'/' + serviceId.toLowerCase() + '/(?<remaining>.*)'"
                replacement: "'/${remaining}'"

      # Дополнительные маршруты для Actuator
      routes:
        - id: actuator_health
          uri: http://localhost:${server.port}
          predicates:
            - Path=/health
          filters:
            - SetPath=/actuator/health

        - id: actuator_info
          uri: http://localhost:${server.port}
          predicates:
            - Path=/info
          filters:
            - SetPath=/actuator/info

        - id: actuator_gateway
          uri: http://localhost:${server.port}
          predicates:
            - Path=/gateway/**
          filters:
            - RewritePath=/gateway/(?<segment>.*), /actuator/gateway/$\{segment}

      # Настройки HTTP клиента
      httpclient:
        connect-timeout: 1000
        response-timeout: 5s
        pool:
          type: elastic
          max-connections: 1000
          max-idle-time: 60s

      # Настройки метрик
      metrics:
        enabled: true

      # Глобальные фильтры
      default-filters:
        - DedupeResponseHeader=Access-Control-Allow-Origin Access-Control-Allow-Credentials
        - name: RequestRateLimiter
          args:
            redis-rate-limiter.replenishRate: 10
            redis-rate-limiter.burstCapacity: 20
            key-resolver: "#{@remoteAddrKeyResolver}"

management:
  endpoints:
    web:
      exposure:
        include: health,info,gateway,metrics,env,beans
      base-path: /actuator
      cors:
        allowed-origins: "*"
        allowed-methods: GET,POST,PUT,DELETE,OPTIONS
        allowed-headers: "*"
        allow-credentials: true
  endpoint:
    health:
      show-details: always
      show-components: always
      probes:
        enabled: true
    gateway:
      enabled: true
    metrics:
      enabled: true
  metrics:
    export:
      prometheus:
        enabled: true
    distribution:
      percentiles-histogram:
        http.server.requests: true
    web:
      server:
        request:
          autotime:
            enabled: true

# Настройки Resilience4j для Circuit Breaker (опционально)
resilience4j:
  circuitbreaker:
    configs:
      default:
        slidingWindowSize: 10
        minimumNumberOfCalls: 5
        permittedNumberOfCallsInHalfOpenState: 3
        waitDurationInOpenState: 5s
        failureRateThreshold: 50
        eventConsumerBufferSize: 10
    instances:
      user-service:
        baseConfig: default
      event-service:
        baseConfig: default
      request-service:
        baseConfig: default
      comment-service:
        baseConfig: default
  retry:
    configs:
      default:
        maxAttempts: 3
        waitDuration: 100ms
        retryExceptions:
          - org.springframework.web.client.HttpServerErrorException
          - java.io.IOException
          - java.util.concurrent.TimeoutException

# Настройки Rate Limiting (опционально)
spring:
  data:
    redis:
      host: localhost
      port: 6379
  cloud:
    gateway:
      filter:
        rate-limiter:
          redis-rate-limiter.replenish-rate: 10
          redis-rate-limiter.burst-capacity: 20

# Логирование
logging:
  level:
    # Основные логи
    org.springframework.cloud.gateway: INFO
    org.springframework.cloud.client.discovery: INFO
    org.springframework.web: INFO

    # Для отладки маршрутизации
    reactor.netty.http.client: WARN
    reactor.netty.http.server: WARN

    # Логи локатора
    org.springframework.cloud.gateway.discovery.DiscoveryClientRouteDefinitionLocator: DEBUG

    # Логи Eureka
    com.netflix.discovery: INFO
    com.netflix.eureka: INFO

    # Логи Circuit Breaker
    io.github.resilience4j: INFO

  pattern:
    console: "%d{yyyy-MM-dd HH:mm:ss.SSS} [%thread] %-5level %logger{36} - %msg%n"
    file: "%d{yyyy-MM-dd HH:mm:ss.SSS} [%thread] %-5level %logger{36} - %msg%n"

  file:
    name: logs/gateway-server.log
    max-size: 10MB
    max-history: 10

# Информация о приложении
info:
  app:
    name: Explore With Me Gateway
    description: API Gateway для микросервисной платформы мероприятий
    version: 0.0.1-SNAPSHOT
    environment: ${spring.profiles.active:default}
  build:
    artifact: ${project.artifactId}
    version: ${project.version}
    time: ${build.time}